---
title: Manually authenticating users
image: "https://og.composio.dev/api/og?title=Manually%20Authenticating%20Users"
description: "Authenticate users to toolkits outside of chat"
keywords: "tool router, authentication, manual, authorize, toolkits"
---

Manual authentication lets you connect users to toolkits outside of the chat flow. Use this when you want to:
- Pre-authenticate users before they start chatting
- Build a custom connections UI in your app

## Create session

Disable the `COMPOSIO_MANAGE_CONNECTIONS` meta-tool so the agent doesn't prompt for auth during chat:

<CodeGroup>
```python
session = await composio.create(
    user="pg-user-550e8400-e29b-41d4",
    manage_connections=False,
)
```
```typescript
const session = await composio.create("pg-user-550e8400-e29b-41d4", {
  manageConnections: false,
});
```
</CodeGroup>

## Check connection status

Use `session.toolkits()` to see which apps the user has connected:

<CodeGroup>
```python
toolkits = await session.toolkits()

for toolkit in toolkits:
    status = toolkit.connected_account.status if toolkit.connected_account else "Not connected"
    print(f"{toolkit.name}: {status}")
```
```typescript
const toolkits = await session.toolkits();

for (const toolkit of toolkits) {
  const status = toolkit.connectedAccount?.status || "Not connected";
  console.log(`${toolkit.name}: ${status}`);
}
```
</CodeGroup>

Each toolkit includes:
- `name`, `slug`, `logo`, `description`
- `connectedAccount` - present if user is connected, includes `id`, `status`, `createdAt`

### Filter and sort

Use filters to show relevant toolkits in your UI:

<CodeGroup>
```python
toolkits = await session.toolkits(
    order_by="popularity",        # Sort by most used
    order_direction="desc",
    category="developer-tools",   # Filter by category
    is_connected=True,            # Only show connected apps
)
```
```typescript
const toolkits = await session.toolkits({
  orderBy: "popularity",        // Sort by most used
  orderDirection: "desc",
  category: "developer-tools",  // Filter by category
  isConnected: true,            // Only show connected apps
});
```
</CodeGroup>

## Generate auth URL

Use `session.authorize()` to generate a [Connect Link](/docs/authenticating-tools#hosted-authentication-connect-link) URL:

<CodeGroup>
```python
connection_request = await session.authorize(
    "gmail",
    callback_url="https://yourapp.com/callback"
)

print(connection_request.redirect_url)
# https://connect.composio.dev/link/ln_abc123
```
```typescript
const connectionRequest = await session.authorize("gmail", {
  callbackUrl: "https://yourapp.com/callback",
});

console.log(connectionRequest.redirectUrl);
// https://connect.composio.dev/link/ln_abc123
```
</CodeGroup>

Redirect the user to `redirectUrl`. After they authenticate, they'll be redirected to your `callbackUrl`.

## Wait for connection

Use `waitForConnection()` to poll until the user completes authentication:

<CodeGroup>
```python
connected_account = await connection_request.wait_for_connection(60000)
print(f"Connected: {connected_account.id}")
```
```typescript
const connectedAccount = await connectionRequest.waitForConnection(60000);
console.log(`Connected: ${connectedAccount.id}`);
```
</CodeGroup>

- Default timeout: 60 seconds (60000ms)
- Throws `ConnectionRequestTimeoutError` if timeout expires
- Throws `ConnectionRequestFailedError` if connection fails or expires

<Note>
If the user closes the Connect Link without completing auth, the connection remains in `INITIATED` status until it expires.
</Note>

## Putting it together

A common pattern is to verify all required connections before starting the agent. For example, a personal assistant might need Gmail, Calendar, Linear, and Slack:

<CodeGroup>
```python
required_toolkits = ["gmail", "googlecalendar", "linear", "slack"]

session = await composio.create(
    user=user_id,
    manage_connections=False,
)

toolkits = await session.toolkits()

def is_connected(slug):
    toolkit = next((t for t in toolkits if t.slug == slug), None)
    return toolkit and toolkit.connected_account

pending = [slug for slug in required_toolkits if not is_connected(slug)]

if pending:
    for slug in pending:
        connection_request = await session.authorize(
            slug,
            callback_url="https://yourapp.com/onboarding"
        )
        # Show connection_request.redirect_url to user

    # Wait for all connections before continuing

# All apps connected, start the agent
tools = await session.tools()
```
```typescript
const requiredToolkits = ["gmail", "googlecalendar", "linear", "slack"];

const session = await composio.create(userId, {
  manageConnections: false,
});

const toolkits = await session.toolkits();

const pending = requiredToolkits.filter((slug) => {
  const toolkit = toolkits.find((t) => t.slug === slug);
  return !toolkit?.connectedAccount;
});

if (pending.length > 0) {
  for (const slug of pending) {
    const connectionRequest = await session.authorize(slug, {
      callbackUrl: "https://yourapp.com/onboarding",
    });
    // Show connectionRequest.redirectUrl to user
  }
  // Wait for all connections before continuing
}

// All apps connected, start the agent
const tools = await session.tools();
```
</CodeGroup>

## Multiple accounts

Users can connect multiple accounts for the same toolkit (e.g., personal and work Gmail). Tool Router uses the most recently connected account by default.

To use a specific account, pass it in the session config:

<CodeGroup>
```python
session = await composio.create(
    user=user_id,
    connected_accounts={
        "gmail": "ca_specific_account_id",
    },
)
```
```typescript
const session = await composio.create(userId, {
  connectedAccounts: {
    gmail: "ca_specific_account_id",
  },
});
```
</CodeGroup>

## Full example

<CodeGroup>
<CodeGroupItem title="Python">
<SnippetCode src="fern/snippets/tool-router/python/manual-auth.py" />
</CodeGroupItem>
<CodeGroupItem title="TypeScript">
<SnippetCode src="fern/snippets/tool-router/typescript/manual-auth.ts" />
</CodeGroupItem>
</CodeGroup>

