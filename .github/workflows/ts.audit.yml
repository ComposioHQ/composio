name: Audit Typescript SDK

on:
  push:
    branches: [main, next]
    paths:
      - "ts/**"
  pull_request:
    branches: [main, next]
    paths:
      - "ts/**"

jobs:
  audit:
    name: Audit
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      - name: Setup PNPM
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
      
      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "20.19.0"
          cache: "pnpm"

      - name: Run pnpm audit (production dependencies only)
        id: audit
        continue-on-error: true
        run: pnpm audit --prod > audit-output.txt 2>&1

      - name: Comment on PR if audit failed
        if: steps.audit.outcome == 'failure' && github.event_name == 'pull_request'
        run: |
          {
            echo "⚠️ **Security Audit Warning**"
            echo ""
            echo "The \`pnpm audit --prod\` check found security vulnerabilities in production dependencies."
            echo ""
            echo "Please review and fix the vulnerabilities. You can try running:"
            echo "\`\`\`bash"
            echo "pnpm audit --fix --prod"
            echo "\`\`\`"
            echo ""
            echo "<details>"
            echo "<summary>Audit output</summary>"
            echo ""
            echo "\`\`\`"
            cat audit-output.txt
            echo "\`\`\`"
            echo ""
            echo "</details>"
          } > audit-comment.txt

      - name: Post audit comment to PR
        if: steps.audit.outcome == 'failure' && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3.0.1
        with:
          file-path: audit-comment.txt
          comment-tag: pnpm-audit-security-warning
