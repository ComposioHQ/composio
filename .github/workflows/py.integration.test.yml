name: Integration Tests

on:
  push:
    branches: [main, next]
    paths:
      - "python/**/*.py"
      - ".github/workflows/py.integration.test.yml"
      - "python/pyproject.toml"
      - "python/composio/integration_test/**"
  pull_request:
    branches: [main, next]
    paths:
      - "python/**/*.py"
      - ".github/workflows/py.integration.test.yml"
      - "python/pyproject.toml"
      - "python/composio/integration_test/**"
  workflow_dispatch: # Allow manual triggering

jobs:
  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/composiohq/dev-base:latest
    permissions: read-all
    env:
      COMPOSIO_API_KEY: ${{ secrets.COMPOSIO_API_KEY_PROD }}
    

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install UV
        uses: astral-sh/setup-uv@v6
        with:
          uv-version: '0.8.19'  # Pin to a recent version that supports --group syntax

      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-0.8.19-${{ hashFiles('python/pyproject.toml') }}
          restore-keys: |
            uv-0.8.19-

      - name: Install Python Dependencies
        working-directory: ./python
        run: |
          uv sync --group dev
          uv pip install -e .

      - name: Verify API Key
        run: |
          if [ -z "$COMPOSIO_API_KEY" ]; then
            echo "::error::COMPOSIO_API_KEY is not set"
            exit 1
          fi
          echo "âœ… COMPOSIO_API_KEY is configured"

      - name: Run Integration Tests
        working-directory: ./python
        run: |
          echo "ðŸ§ª Running Integration Tests..."
          uv run pytest composio/integration_test/ -v --tb=short --maxfail=3
        timeout-minutes: 15


      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            python/composio/integration_test/
          retention-days: 7

  test-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always()
    
    steps:
      - name: Check Integration Test Results
        run: |
          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "âœ… All integration tests passed successfully!"
            echo "## âœ… Integration Tests Passed" >> $GITHUB_STEP_SUMMARY
            echo "All integration tests completed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Integration tests failed or were cancelled"
            echo "## âŒ Integration Tests Failed" >> $GITHUB_STEP_SUMMARY
            echo "Some integration tests failed. Please check the test results above." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
