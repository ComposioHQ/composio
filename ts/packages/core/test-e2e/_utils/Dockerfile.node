# Reusable Dockerfile for Node.js e2e tests
# Usage: docker build -f Dockerfile.node --build-arg NODE_VERSION=20.17.0 --build-arg TEST_DIR=... --build-arg TEST_CMD="node test.cjs" -t test-name .
ARG NODE_VERSION=20.17.0

FROM node:${NODE_VERSION}-slim

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# Copy pnpm workspace files
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY tsconfig.base.json ./

# Copy all ts/packages (pre-built)
COPY ts/packages/ ./ts/packages/

# Install dependencies using pnpm
RUN pnpm install --frozen-lockfile --ignore-scripts

# Test directory (relative to /app)
ARG TEST_DIR
WORKDIR /app/${TEST_DIR}

# Command to run the test (e.g., "node test.cjs", "node test.mjs", "pnpm test")
ARG TEST_CMD="echo 'No TEST_CMD specified'"
ENV TEST_CMD=${TEST_CMD}

CMD ["sh", "-c", "${TEST_CMD}"]
