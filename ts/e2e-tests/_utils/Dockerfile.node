# Reusable Dockerfile for Node.js e2e tests
# Usage: docker build -f Dockerfile.node --build-arg NODE_VERSION=20.19.0 --build-arg TEST_DIR=... --build-arg TEST_CMD="node test.cjs" -t test-name .
#
# Uses official node:slim images. For multi-version testing, run the build/run
# multiple times with different NODE_VERSION values from the shell script.

ARG NODE_VERSION=20.19.0

FROM node:${NODE_VERSION}-slim

ENV PNPM_HOME="/pnpm"
ENV BUN_INSTALL="/usr/local"
ENV PATH="$BUN_INSTALL/bin:$PNPM_HOME:$PATH"

WORKDIR /app

COPY package.json \
  .bun-version \
  ./

RUN apt update -y && \
  apt install -y curl unzip

# Install corepack (for pnpm) and bun
RUN npm i -g corepack@latest \
  && corepack enable \
  && curl -fsSL https://bun.com/install | BUN_INSTALL=/usr/local bash \
  && bun --version

# Copy pnpm workspace files
COPY pnpm-lock.yaml \
  pnpm-workspace.yaml \
  .pnpmfile.cjs \
  tsconfig.base.json \
  tsdown.config.base.ts \
  ./

# Copy all ts/packages (pre-built)
COPY ts/packages/ ./ts/packages/

# Copy pre-install scripts
COPY ts/scripts/pre-install.sh ./ts/scripts/pre-install.sh
COPY ts/scripts/pre-install/ ./ts/scripts/pre-install/

# Copy e2e tests
COPY ts/e2e-tests/ ./ts/e2e-tests/

# Install dependencies using pnpm
# Note: We intentionally don't use --mount=type=cache for the pnpm store here
# because it causes native binding issues (e.g., rolldown-binding) across builds
RUN pnpm install --frozen-lockfile

# Build and install composio CLI binary
# This is a simplified version of ts/packages/cli/scripts/build-binary.ts + install-binary.ts
WORKDIR /app/ts/packages/cli
RUN bun build ./src/bin.ts \
  --env DEBUG_OVERRIDE_* \
  --compile \
  --production \
  --outfile /usr/local/bin/composio

# Test directory (relative to /app)
ARG TEST_DIR
WORKDIR /app/${TEST_DIR}

# Command to run the test (e.g., "node test.cjs", "node test.mjs", "pnpm test", "bun test")
ARG TEST_CMD="echo 'No TEST_CMD specified'"
ENV TEST_CMD=${TEST_CMD}

CMD ["sh", "-c", "${TEST_CMD}"]
